<?xml version="1.0" encoding="utf-8"?>
<openerp>
	<data>
		<report id="pmUnsubscribeReport_action"
			string="Informa baja"
			model="setir.pm"
			report_type="qweb-pdf"
			file="setirOperations.pmUnsubscribeReport"
			name="setirOperations.pmUnsubscribeReport"
		/>
		<template id="pmUnsubscribeReport">
			<t t-call="report.html_container">
				<t t-call="report.external_layout">
					<div class="page">
						<div class="col-xs-offset-9 col-xs-3">
							<t t-set="first_pm_type" t-value="'sin_tipo'"/>
							<t t-foreach="docs" t-as="rec">
								<t t-if="rec_first">
									<div>
										<img t-if="rec.idProvider.image_medium"
											t-att-src="'data:image/png;base64,%s' % rec.idProvider.image_medium"
											style="max-height: 55px;"/>
									</div>
									<t t-esc="rec.idProvider.name"/><br></br>
									<t t-set="first_pm_type" t-value="rec.ePMType"/>

									<!-- direccion por defecto es la direccion principal del proveedor -->
									<t t-set="addressName" t-value="'envio-'+rec.ePMType"/>
									<!-- t t-set="addressName" t-value="'envio-obu'"/ -->
									<t t-set="specificDeliveryAddressFound" t-value="False"/>
									<t t-set="generalDeliveryAddressFound" t-value="False"/>
									<t t-esc="addressName"/><br></br>
									<!-- buscamos la dirección de envío específica para el tipo de medio de pago -->
									<t t-foreach="rec.idProvider.child_ids" t-as="contact">
										<t t-if="contact.type =='delivery' and contact.name == addressName and not specificDeliveryAddressFound">
											<t t-set="specificDeliveryAddressFound" t-value="True"/>
											<t t-call="setirOperations.pmAddress">
												<t t-set="contact" t-value="contact"/>
												<t t-raw="0"/>
											</t>
										</t>
									</t>
									<!-- buscamos la dirección de envío generica si la específica no se ha encontrada -->
									<t t-foreach="rec.idProvider.child_ids" t-as="contact">
										<t t-if="contact.type =='delivery' and not specificDeliveryAddressFound and not generalDeliveryAddressFound">
											<t t-set="generalDeliveryAddressFound" t-value="True"/>
											<t t-call="setirOperations.pmAddress">
												<t t-set="contact" t-value="contact"/>
												<t t-raw="0"/>
											</t>
										</t>
									</t>
									<!-- no se ha encontrado nada, usamos la direccion por defecto -->
									<t t-if="not specificDeliveryAddressFound and not generalDeliveryAddressFound">
										<t t-call="setirOperations.pmAddress">
											<t t-set="contact" t-value="rec.idProvider"/>
											<t t-raw="0"/>
										</t>
									</t>
								</t>
							</t>
						</div>
						
						<p></p><p></p>
						<div class="col-xs-offset-4 col-xs-4">
							<br></br><p><strong>Baja de los medios de pago</strong></p>
							
						</div>
						<br></br><br></br>
						<div class="col-xs-12">
							<p>Estimadas/os Sras/es,</p><br></br>
							<p>Rogamos que procede con la baja de los siguientes medios de pago :</p>
						</div>
						<br></br><br></br>
						<!-- SOLO se mostarrán medios de pago del mismo tipo que el primero seleccionado  -->
						<t t-call="setirOperations.pmItems">
							<t t-set="current_state" t-value="'baja'"/>
							<t t-set="current_type" t-value="first_pm_type"/>
							<t t-raw="0"/>
						</t>
					</div>
				</t>
			</t>
		</template>
		<!-- bloque de dirección formateada -->
		<template id="pmAddress">
			<t t-if="contact.street"><span t-esc="contact.street"/><br></br></t>
			<t t-if="contact.street2"><span t-esc="contact.street2"/><br></br></t>
			<t t-if="contact.zip or contact.city">
				<span t-esc="contact.zip"/>
				<span t-esc="contact.city"/>
				<br></br>
			</t>
			<t t-if="contact.state_id.name"><span t-esc="contact.state_id.name"/><br></br></t>
			<t t-if="contact.country_id.name"><span t-esc="contact.country_id.name"/><br></br></t>
		</template>
		<!-- bloque de la lista de los medios de pago -->
		<template id="pmItems">
			<table class="table table-condensed">
				<thead>
					<tr>
						<th class="text-left">Customer</th>
						<th class="text-left">Customer code</th>
						<th class="text-left">Product</th>
						<th class="text-left">Product pack</th>
						<th class="text-left">Type</th>
						<th class="text-left">PAN</th>
						<th class="text-left">S/N</th>
						<th class="text-left">Plate number</th>
						<th class="text-left">Country</th>
						<th class="text-left">State</th>
						<th class="text-left">Unsubscribe reason</th>
					</tr>
				</thead>
				<tbody class="pm_unsubscribe_tbody">
					<tr t-foreach="docs" t-as="doc">
						<!-- t t-set="doc" t-value="doc.with_context({'lang':doc.partner_id.lang})"/ -->
						<t t-if="doc.eRegisterState == current_state and doc.ePMType == current_type">
							<td class="text-left">
								<span t-esc="doc.idCustomer.name"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.idCustomer.ref"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.idProductPM.name"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.idAssocPackTmpl.name"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.ePMType"/>
							</td>
							<td class="text-right">
								<span t-esc="doc.strPAN"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.strSN"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.strPN"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.idCountry.name"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.eRegisterState"/>
							</td>
							<td class="text-left">
								<span t-esc="doc.idUnsubscribeReason.name"/>
							</td>
						</t>
					</tr>
				</tbody>
			</table>
		</template>		
	</data>
</openerp>